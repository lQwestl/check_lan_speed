# LAN Speed Monitor for GL.iNet Flint-2 (OpenWRT)

Этот скрипт проверяет скорость 2.5G LAN порта (`lan1`) на маршрутизаторе GL.iNet Flint-2 с OpenWRT.  
Если скорость падает ниже 2.5G, скрипт **перезапускает интерфейс** и отправляет уведомление в Telegram.

---

## Особенности

- Проверка скорости физического порта `lan1`.
- Перезапуск логического интерфейса `lan` при падении скорости.
- Логирование событий в `/tmp/lan_speed_monitor.log`.
- Уведомления в Telegram о падении скорости и успешном перезапуске интерфейса.
- Использует `ethtool` для проверки скорости и `ubus` для управления интерфейсом.

---

## Установка

1. Скачайте скрипт на маршрутизатор:

```bash
# через wget
wget https://raw.githubusercontent.com/lQwestl/check_lan_speed/main/check_lan_speed.sh -O /root/check_lan_speed.sh

# или через curl
curl -L https://raw.githubusercontent.com/lQwestl/check_lan_speed/main/check_lan_speed.sh -o /root/check_lan_speed.sh
```

2. Сделайте скрипт исполняемым:

```bash
chmod +x /root/check_lan_speed.sh
```

3. Настройте cron для регулярного запуска (например, каждые 5 минут):

```bash
crontab -e
```

Добавьте строку:

```bash
*/5 * * * * /root/check_lan_speed.sh
```

---

## Настройка Telegram

В скрипте замените значения переменных:

```bash
TG_TOKEN="XXXXXXX"     # Замените на свой токен Telegram бота
CHAT_ID="XXXXXXX"      # Замените на свой chat_id или ID группы
```

### 1. Получение токена бота

1. В Telegram найдите бота [BotFather](https://t.me/botfather) и начните с ним диалог.
2. Отправьте команду `/newbot` и следуйте инструкциям.
3. В конце BotFather даст вам **токен** вида `123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11`.

### 2. Получение Chat ID

#### Для личного чата с ботом:

1. Начните диалог с вашим ботом.
2. Откройте браузер и перейдите по ссылке:
```
https://api.telegram.org/bot<TG_TOKEN>/getUpdates
```
   Замените `<TG_TOKEN>` на токен вашего бота.
3. Отправьте любое сообщение боту. В ответе JSON найдите:
```json
"chat": {
  "id": 123456789,
  "first_name": "Ваше_имя",
  "type": "private"
}
```
`id` — это ваш `CHAT_ID`.

#### Для группы или супергруппы:

1. Добавьте бота в группу.
2. Дайте боту **права на чтение сообщений**.
3. Отправьте любое сообщение в группу.
4. Перейдите по ссылке:
```
https://api.telegram.org/bot<TG_TOKEN>/getUpdates
```
5. В JSON-ответе найдите блок `"chat"` с `"type": "supergroup"`:
```json
"chat": {
  "id": -1001234567890,
  "title": "Название группы",
  "type": "supergroup"
}
```
`id` (начинающийся с `-100`) — это `CHAT_ID` группы.


---

## Логи

- Скрипт пишет логи в:

```
/tmp/lan_speed_monitor.log
```

- Состояние последней проверки хранится в:

```
/tmp/lan_speed_state
```

- Для очистки логов можно настроить cron раз в неделю:

```
0 3 * * 0 > /tmp/lan_speed_monitor.log
```

---

## Зависимости

- `ethtool`
- `ubus`
- `curl` (для отправки уведомлений в Telegram)

---

## Примечания

- Скрипт проверяет только **скорость порта lan1**.  
- При необходимости можно изменить `LAN_IF` и `LOG_IF` на другие порты.  
- Уведомления отправляются только при падении скорости **2 раза подряд**, чтобы избежать ложных срабатываний.
